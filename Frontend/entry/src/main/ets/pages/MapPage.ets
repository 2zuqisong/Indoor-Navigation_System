import { ApiService } from '../services/ApiService'
import { Point } from '../models/Point'
import { PathResponse, PathNode } from '../models/NavigationModel'
import { MapCanvas } from '../components/MapCanvas'

/**
 * å®¤å†…å¯¼èˆªä¸»é¡µé¢
 *
 * ä¸šåŠ¡æµç¨‹ï¼š
 *   1. ç”¨æˆ·ç‚¹å‡»åœ°å›¾ â†’ é€‰æ‹©èµ·ç‚¹ï¼ˆå¸é™„åˆ°è“è‰²å¯¼èˆªèŠ‚ç‚¹ï¼‰
 *   2. è‡ªåŠ¨åˆ‡æ¢ä¸º"é€‰æ‹©ç»ˆç‚¹"æ¨¡å¼ â†’ ç”¨æˆ·å†æ¬¡ç‚¹å‡» â†’ é€‰æ‹©ç»ˆç‚¹
 *   3. ç‚¹å‡»"å¼€å§‹å¯¼èˆª" â†’ å‘é€ startId / endId ç»™åç«¯
 *   4. åç«¯ Dijkstra è®¡ç®—æœ€çŸ­è·¯å¾„ â†’ è¿”å›è·¯å¾„ + æ€»è·ç¦»
 *   5. å‰ç«¯åœ¨åœ°å›¾ä¸Šç»˜åˆ¶è“è‰²è™šçº¿æœ€çŸ­è·¯å¾„
 */
@Entry
@Component
struct MapPage {

  // ===== å¯¼èˆªæ¨¡å¼ =====
  // 'start' = é€‰èµ·ç‚¹, 'end' = é€‰ç»ˆç‚¹, 'ready' = å¯å¯¼èˆª, 'navigating' = å·²å‡ºè·¯å¾„
  @State mode: string = 'start'

  // ===== èµ·ç‚¹ =====
  @State startNodeId: number = -1
  @State startNodeName: string = ''
  @State startPosX: number = -1
  @State startPosY: number = -1

  // ===== ç»ˆç‚¹ =====
  @State endNodeId: number = -1
  @State endNodeName: string = ''
  @State endPosX: number = -1
  @State endPosY: number = -1

  // ===== å¯¼èˆªç»“æœ =====
  @State path: Point[] = []
  @State totalDistance: number = 0

  // ===== UI çŠ¶æ€ =====
  @State isLoading: boolean = false
  @State statusMessage: string = ''

  // =================================================================
  //  ä¸šåŠ¡é€»è¾‘
  // =================================================================

  /** å¤„ç†åœ°å›¾ç‚¹å‡» */
  handleMapClick(x: number, y: number, area: string, nodeId: number): void {
    // æ­£åœ¨å¯¼èˆªä¸­ï¼Œç‚¹å‡»æ— æ•ˆ
    if (this.mode === 'navigating' || this.isLoading) {
      return
    }
    // å¿…é¡»ç‚¹ä¸­è“è‰²å¯¼èˆªèŠ‚ç‚¹é™„è¿‘
    if (nodeId < 0) {
      this.statusMessage = 'è¯·ç‚¹å‡»è“è‰²å¯¼èˆªç‚¹æ¥é€‰æ‹©ä½ç½®'
      return
    }
    this.statusMessage = ''

    if (this.mode === 'start') {
      // â€”â€” é€‰æ‹©èµ·ç‚¹ â€”â€”
      this.startNodeId = nodeId
      this.startNodeName = area
      this.startPosX = x
      this.startPosY = y
      this.mode = 'end' // è‡ªåŠ¨åˆ‡æ¢åˆ°é€‰ç»ˆç‚¹
    } else if (this.mode === 'end' || this.mode === 'ready') {
      // â€”â€” é€‰æ‹©ç»ˆç‚¹ â€”â€”
      if (nodeId === this.startNodeId) {
        this.statusMessage = 'ç»ˆç‚¹ä¸èƒ½ä¸èµ·ç‚¹ç›¸åŒ'
        return
      }
      this.endNodeId = nodeId
      this.endNodeName = area
      this.endPosX = x
      this.endPosY = y
      this.path = [] // æ¸…é™¤æ—§è·¯å¾„
      this.mode = 'ready'
    }
  }

  /** è°ƒç”¨åç«¯è·å–æœ€çŸ­è·¯å¾„ */
  async startNavigation(): Promise<void> {
    this.isLoading = true
    this.statusMessage = ''

    try {
      let result: PathResponse | null =
        await ApiService.planRoute(this.startNodeId, this.endNodeId)

      if (result === null) {
        this.statusMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨'
        this.isLoading = false
        return
      }
      if (!result.success) {
        this.statusMessage = result.message
        this.isLoading = false
        return
      }

      // åç«¯è¿”å›çš„ PathNode[] â†’ è½¬ä¸º Point[] ä¾› Canvas ç»˜åˆ¶
      let points: Point[] = []
      for (let i = 0; i < result.path.length; i++) {
        let node: PathNode = result.path[i]
        let pt: Point = { x: node.x, y: node.y }
        points.push(pt)
      }
      this.path = points
      this.totalDistance = result.totalDistance
      this.mode = 'navigating'
    } catch (err) {
      this.statusMessage = 'è·¯å¾„è§„åˆ’å¼‚å¸¸'
      console.error('startNavigation error:', err)
    }
    this.isLoading = false
  }

  /** é‡ç½®å…¨éƒ¨çŠ¶æ€ */
  resetNavigation(): void {
    this.mode = 'start'
    this.startNodeId = -1
    this.startNodeName = ''
    this.startPosX = -1
    this.startPosY = -1
    this.endNodeId = -1
    this.endNodeName = ''
    this.endPosX = -1
    this.endPosY = -1
    this.path = []
    this.totalDistance = 0
    this.statusMessage = ''
    this.isLoading = false
  }

  // =================================================================
  //  é¡µé¢å¸ƒå±€
  // =================================================================

  build() {
    Column() {

      // =============== æ ‡é¢˜æ  ===============
      Row() {
        Text('å®¤å†…å¯¼èˆª')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor('#263238')
        Blank()
        Text('1F')
          .fontSize(13)
          .fontColor('#546E7A')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(4)
          .backgroundColor('#ECEFF1')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })

      // =============== åœ°å›¾ç”»å¸ƒ ===============
      MapCanvas({
        path: this.path,
        startPosX: this.startPosX,
        startPosY: this.startPosY,
        endPosX: this.endPosX,
        endPosY: this.endPosY,
        onMapClick: (x: number, y: number, area: string, nodeId: number) => {
          this.handleMapClick(x, y, area, nodeId)
        }
      })

      // =============== å¯¼èˆªä¿¡æ¯é¢æ¿ ===============
      Column() {

        // é”™è¯¯ / æç¤ºä¿¡æ¯
        if (this.statusMessage.length > 0) {
          Text(this.statusMessage)
            .fontSize(13)
            .fontColor('#E65100')
            .width('100%')
            .margin({ bottom: 8 })
        }

        if (this.mode === 'start') {
          // â€”â€” ç­‰å¾…é€‰æ‹©èµ·ç‚¹ â€”â€”
          Row() {
            Text('ğŸ‘†')
              .fontSize(18)
              .margin({ right: 8 })
            Text('è¯·ç‚¹å‡»åœ°å›¾ä¸Šçš„è“è‰²èŠ‚ç‚¹é€‰æ‹©èµ·ç‚¹')
              .fontSize(14)
              .fontColor('#78909C')
          }
          .width('100%')
        }

        if (this.mode !== 'start') {
          // â€”â€” èµ·ç‚¹å·²é€‰ â€”â€”
          Row() {
            Text('â—')
              .fontSize(16)
              .fontColor('#4CAF50')
              .margin({ right: 8 })
            Text('èµ·ç‚¹ï¼š' + this.startNodeName)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#2E7D32')
          }
          .width('100%')
          .margin({ bottom: 6 })
        }

        if (this.mode === 'end') {
          // â€”â€” ç­‰å¾…é€‰æ‹©ç»ˆç‚¹ â€”â€”
          Row() {
            Text('ğŸ‘†')
              .fontSize(18)
              .margin({ right: 8 })
            Text('è¯·ç‚¹å‡»åœ°å›¾é€‰æ‹©ç›®çš„åœ°')
              .fontSize(14)
              .fontColor('#78909C')
          }
          .width('100%')
        }

        if (this.mode === 'ready' || this.mode === 'navigating') {
          // â€”â€” ç»ˆç‚¹å·²é€‰ â€”â€”
          Row() {
            Text('â—')
              .fontSize(16)
              .fontColor('#F44336')
              .margin({ right: 8 })
            Text('ç»ˆç‚¹ï¼š' + this.endNodeName)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#C62828')
          }
          .width('100%')
          .margin({ bottom: 6 })
        }

        if (this.mode === 'navigating') {
          // â€”â€” è·¯å¾„ç»“æœ â€”â€”
          Row() {
            Text('ğŸ“')
              .fontSize(14)
              .margin({ right: 8 })
            Text('æœ€çŸ­è·ç¦»ï¼š' + this.totalDistance.toFixed(1))
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#1565C0')
          }
          .width('100%')
        }
      }
      .width('100%')
      .padding(16)
      .margin({ left: 12, right: 12, top: 10 })
      .backgroundColor('#FFFFFF')
      .borderRadius(12)

      // =============== æ“ä½œæŒ‰é’®åŒº ===============

      if (this.isLoading) {
        Row() {
          LoadingProgress()
            .width(28)
            .height(28)
            .color('#1976D2')
          Text('æ­£åœ¨è§„åˆ’è·¯çº¿...')
            .fontSize(14)
            .fontColor('#78909C')
            .margin({ left: 10 })
        }
        .margin({ top: 20 })
        .justifyContent(FlexAlign.Center)
      }

      if (this.mode === 'ready' && !this.isLoading) {
        Row() {
          Button('å¼€å§‹å¯¼èˆª')
            .width('48%')
            .height(44)
            .backgroundColor('#1976D2')
            .fontColor('#FFFFFF')
            .fontSize(16)
            .borderRadius(22)
            .onClick(() => {
              this.startNavigation()
            })
          Button('é‡æ–°é€‰æ‹©')
            .width('38%')
            .height(44)
            .backgroundColor('#ECEFF1')
            .fontColor('#546E7A')
            .fontSize(15)
            .borderRadius(22)
            .onClick(() => {
              this.resetNavigation()
            })
        }
        .width('90%')
        .justifyContent(FlexAlign.SpaceBetween)
        .margin({ top: 16 })
      }

      if (this.mode === 'navigating' && !this.isLoading) {
        Button('é‡æ–°è§„åˆ’')
          .width('60%')
          .height(44)
          .backgroundColor('#FF7043')
          .fontColor('#FFFFFF')
          .fontSize(16)
          .borderRadius(22)
          .margin({ top: 16 })
          .onClick(() => {
            this.resetNavigation()
          })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
